<!DOCTYPE html>
<head>
    <link href="https://unpkg.com/tabulator-tables@4.8.4/dist/css/tabulator.min.css" rel="stylesheet">
    <script type="text/javascript" src="https://unpkg.com/tabulator-tables@4.8.4/dist/js/tabulator.min.js"></script>
    <script src="https://apis.google.com/js/platform.js" async defer></script>
    <meta name="google-signin-client_id" content="{{ GOOGLE_CLIENT_ID }}">
</head>
<body>
    <h1>URL Shortener</h1>
    <p id="current-email">Not logged in</p>
    <div class="g-signin2" data-onsuccess="onSignIn"></div>
    <hr>

    <h2>Existing redirects</h2>
    <div id="existing-redirects"></div>
    <hr>

    <h2>Create redirect</h2>
    <table>
        <tbody>
            <tr>
                <td><label for="short">Shortened Name</label></td>
                <td><input id="short"></td>
            </tr>
            <tr>
                <td><label for="url">Original URL</label></td>
                <td><input id="url"></td>
            </tr>
            <tr>
                <td colspan="2"><button type="submit">Submit</button></td>
            </tr>
        </tbody>
    </table>
    <script>
        let token, redirects, currentUserEmail;

        const $currentEmail = document.getElementById("current-email");
        const $existingRedirects = document.getElementById("existing-redirects");
        const $short = document.getElementById("short");
        const $url = document.getElementById("url");
        
        const table = new Tabulator($existingRedirects, {
            reactiveData: true,
            index: "shortName",
            columns: [
                { title: "Shortened Name", field: "shortName", sorter: "string" },
                { title: "Redirect URL", field: "url", sorter: "string" },
                { title: "Created At", field: "createdAt", sorter: "string" },
                { title: "Delete", field: "shortName", sorter: "string" },
            ],
        });

        function onSignIn(googleUser) {
            token = googleUser.getAuthResponse().id_token;
            currentUserEmail = googleUser.getBasicProfile().getEmail();
            $currentEmail.innerText = `Logged in as ${currentUserEmail}`;
        }

        function queryApi(path, data={}, method="GET") {
            const headers = { "Authorization": `Bearer ${token}` };

            switch (method.toUpperCase()) {
                case "GET": {
                    const params = new URLSearchParams();
                    for (const [k, v] of Object.entries(data)) params.append(k, v);
                    return fetch(`/api/${path}?${params}`, { headers }).then(r => r.json());
                }
                case "POST": {
                    headers["Content-Type"] = "application/json";
                    return fetch(`/api/${path}`, {
                        method: "POST",
                        headers,
                        body: JSON.stringify(data),
                    }).then(r => r.json());
                }
                default:
                    throw new Error("Unsupported queryApi method");
            }
        }

        async function createRedirect(shortName, url) {
            const result = await queryApi("create", {
                shortName,
                url,
            }, "POST");
            if (result.status !== "success") {
                alert(result.message);
                return;
            }
            redirects.push({
                shortName,
                url,
                createdAt: Date.now(),
                createdBy: currentUserEmail,
            });
        }

        async function deleteRedirect(shortName) {
            const result = await queryApi("delete", {
                shortName,
            }, "POST");
            if (result.status !== "success") {
                alert(result.message);
                return;
            }
            const index = redirects.findIndex(item => item.shortName === shortName);
            if (index > -1) {
                redirects.splice(index, 1);
            }
        }

        async function listRedirects(short) {
            const result = await queryApi("list");
            if (result.status !== "success") {
                alert(result.message);
                return;
            }
            redirects = result.result;
            table.setData(redirects);
        }
    </script>
</body>
